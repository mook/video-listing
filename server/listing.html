<!DOCTYPE html>
<html>
    <head>
        <title>{{ $.Name }}</title>
        <link href="data:text/plain," rel="icon">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
          :root {
            --color-foreground: #111;
            --color-dimmed: #888;
            --color-background: #eee;
            --thumb-size: 69px;
          }

          @media (prefers-color-scheme: dark) {
            :root {
              --color-foreground: #eee;
              --color-dimmed: #666;
              --color-background: #111;
            }
          }

          :root {
            color: var(--color-foreground);
            background: var(--color-background);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 5vw;
            margin: 0;
          }
          body {
            margin: 0;
          }
          header[role="listitem"] {
            font-weight: bold;
            border-bottom-color: var(--color-foreground);
            border-bottom-width: 2px;
            position: sticky;
            top: 0;
            min-height: calc(var(--thumb-size) + 0.2em);
            background: var(--color-background);
            padding: 0.5em;
            align-items: start;
          }
          #menu {
            border: none;
            background: transparent;
            color: var(--color-foreground);
            font: inherit;
          }
          ul {
            list-style: none;
            margin: 0;
            padding: 0;
          }
          *[role="listitem"] {
            display: flex;
            flex-direction: row;
            border: 0;
            border-bottom: 1px solid color-mix(in hsl, var(--color-dimmed) 60%, transparent);
            padding: 0;
          }
          *[role="listitem"][data-seen] {
            color: var(--color-dimmed);
          }
          *[role="listitem"][onclick] {
            cursor: pointer;
          }
          .directories *[role="listitem"] {
            background-color: color-mix(in hsl, var(--color-background) 90%, var(--color-dimmed));
          }
          .thumb {
            display: inline-block;
            width: var(--thumb-size);
            height: var(--thumb-size);
            min-width: var(--thumb-size);
            min-height: var(--thumb-size);
            margin-right: 0.5em;
            vertical-align: top;
            object-fit: cover;
            object-position: center center;
          }
          .thumb img {
            /* fallback */
            width: 100%;
            height: 100%;
          }
          .title {
            display: inline-block;
            flex-grow: 1;
          }
          .translation {
            font-size: 70%;
            color: var(--color-dimmed);
          }
          .directories .title > :nth-child(n + 3 of .translation) {
            display: none;
          }

          #override {
            border: 1px solid var(--color-foreground);
            color: var(--color-foreground);
            background: var(--color-background);
            &::backdrop {
              background-color: black;
              opacity: 0.6;
            }
            & > form {
              display: grid;
              grid-auto-columns: auto auto;
            }
            & h2 {
              grid-column: 1 / 3;
            }
            & #override-error {
              &:empty {
                display: none;
              }
            }
            & input[type="submit"] {
              grid-column: 2 / 3;
            }
          }

          :any-link {
            color: inherit;
            text-decoration: none;
          }
        </style>
        <script>
          function seen(event) {
            const target = event.currentTarget;
            const path = target.getAttribute("data-path");
            const seen = target.hasAttribute("data-seen");
            fetch(`/m/${ path }?${ !seen }`, {
              method: 'POST',
            }).then(({ok}) => {
              if (ok) {
                if (seen) {
                  target.removeAttribute("data-seen");
                } else {
                  target.setAttribute("data-seen", true);
                }
              }
            }).catch(ex => console.error(ex));
          }
          function rescan(event) {
            const path = event.currentTarget.getAttribute("data-path");
            fetch(`/r/${ path }`, { method: 'POST' }).then(({ok}) => {
              if (ok) {}
            }).catch(ex => console.error(ex));
          }
          function openOverride() {
            const dialog = document.getElementById("override");
            dialog.showModal();
          }
          function submitOverride() {
            const dialog = document.getElementById("override");
            const path = dialog.getAttribute("data-path");
            fetch(`/o/${ path }`,
              { method: 'POST', body: JSON.stringify({
                id: parseInt(document.getElementById('override-id').value, 10),
                force: document.getElementById('override-force').checked,
                mark: document.getElementById('override-mark').checked,
              }) }
            ).then(resp => {
              if (resp.ok) {
                dialog.close();
              } else {
                resp.text().then(body => {
                  document.getElementById("override-error").textContent = body;
                });
              }
            })
          }
        </script>
    </head>
    <body>
      {{ define "thumbnail" }}
        <object class="thumb" data="/i/{{ .EscapedFullPath }}" type="image/jpeg">
          {{ if .Fallback }}
            <picture>
              <source media="(prefers-color-scheme: light)"
                srcset="/i/{{ .Fallback }}.svg?666" />
              <source media="(prefers-color-scheme: dark)"
                srcset="/i/{{ .Fallback }}.svg?222" />
              <img src="/i/{{ .Fallback }}.svg">
            </picture>
          {{ end }}
        </object>
      {{ end }}
      <header role="listitem">
        <a
          {{ if .EscapedFullPath }} href=".." {{ end }}
        >
          {{ template "thumbnail" . }}
        </a>
        <ul class="title">
          <li>{{ .Name }}</li>
          {{ range .Translations }}
            {{ if . }}
              <li class="translation">{{ . }}</li>
            {{ end }}
          {{ end }}
        </ul>
        <button id="menu" onclick="openOverride()">&#8942;</button>
      </header>
      <ul class="directories">
          {{ range $.Directories }}
          <a href="/l/{{ .EscapedFullPath }}/">
            <li role="listitem" {{ if .Seen }} data-seen="true" {{ end }} >
              {{ template "thumbnail" . }}
              <ul class="title">
                <li>{{ .Name }}</li>
                {{ range .Translations }}
                  {{ if . }}
                    <li class="translation">{{ . }}</li>
                  {{ end }}
                {{ end }}
              </ul>
            </li>
          </a>
          {{ end }}
      </ul>
      <ul class="files">
          {{ range $.Files }}
          <li
            role="listitem"
            {{ if .Seen }} data-seen="true" {{ end }}
            data-path="{{ .EscapedFullPath }}"
            onclick="seen(event)"
            >
            {{ template "thumbnail" . }}
            <div class="title">{{ .Title }}</div>
          </li>
          {{ end }}
      </ul>
      <dialog id="override" data-path="{{ .EscapedFullPath }}" closedby="any">
        <form method="dialog" onsubmit="submitOverride()">
          <h2>{{ .Name }}</h2>
          <label for="override-id">AniList ID</label>
          <input id="override-id" name="id" type="number" min="-1" value={{ .AniListID }}>
          <label for="override-force">Force lookup</label>
          <input id="override-force" name="force" type="checkbox" {{ if eq .AniListID 0 }} checked {{ end }} >
          <label for="override-mark">Toggle all</label>
          <input id="override-mark" name="mark" type="checkbox">
          <span id="override-error"></span>
          <input type="submit">
        </form>
      </dialog>
    </body>
</html>
